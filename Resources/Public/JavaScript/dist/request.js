import g from"./utility.js";import a from"@typo3/backend/notification.js";import q from"nprogress";class h{constructor(){const t=this,o=document.getElementById("request"),n=document.getElementById("response"),e=document.getElementById("preparedEndpoint"),s=document.getElementById("response-result"),c=document.getElementById("response"),u=document.querySelector("#reusableRequest"),d=u?.querySelector('*[type="submit"]')?.querySelector("span.value"),p=u?.querySelector('button[class*="-delete"]'),m=document.querySelectorAll(".reusable-request-table .flush-cache:not(.disabled)"),b=document.querySelectorAll(".reusable-request-table .warmup-cache");t.initializeArrayFormHandlers(),t.handleFormSubmit("#request",function(r){},function(r){g.toggleElement(c,"block"),[...document.querySelectorAll(".preparedEndpoint")].forEach(function(y){y.tagName.toLowerCase()==="input"?y.value=r.preparedEndpoint:y.innerHTML=r.preparedEndpoint}),document.getElementById("response-raw").innerHTML=r.responseRawFormatted,document.getElementById("response-modified").innerHTML=r.response;let f=document.querySelector('input[name="request#parameters"]'),i=document.querySelector('input[name="request#acceptHeader"]');f.value=r.arguments,i.value=r.acceptHeader,a.success("Temporary Request","The request has successfully been sent to the API",5)}),t.handleFormSubmit("#reusableRequest",function(r){if(r.get("request#preparedEndpoint")===null)return a.error("Reusable Request",'Missing prepared endpoint url. Use the "Temporary Request" to build the required endpoint.',5),!1},function(r){t.updateFormValues("#reusableRequest",r),a.success("Reusable Request","The reusable request was successfully saved",5)}),m.forEach(r=>{t.handleListActionClick(r,f=>{const i=r.closest("tr").querySelector(".cache .badge");r.classList.add("disabled"),i.classList.remove("bg-success"),i.classList.add("bg-danger"),i.setAttribute("title","not cached")})}),b.forEach(r=>{t.handleListActionClick(r,f=>{const i=r.closest("tr").querySelector(".cache .badge");i.classList.remove("bg-danger"),i.classList.add("bg-success");let y=new Date(f.data.expires*1e3).toLocaleString("de-DE",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}).replace(",","");i.setAttribute("title","expiration: "+y),r.closest(".btn-group").querySelector(".flush-cache").classList.remove("disabled")})})}initializeArrayFormHandlers(){const t=document.querySelector("#request"),o=t?.querySelectorAll(".request-input-array button.add"),n=t?.querySelectorAll(".request-input-array button.remove");o?.forEach(e=>{e.addEventListener("click",s=>{this.addArrayInput(s)})}),n?.forEach(e=>{e.addEventListener("click",s=>{this.removeArrayInput(s)})})}addArrayInput(t){t.preventDefault();const o=t.currentTarget?.parentNode,n=o.parentNode.insertBefore(o.cloneNode(!0),o.nextSibling);n.querySelector("input:nth-child(2)").value="",n.querySelector("button.add")?.addEventListener("click",e=>{this.addArrayInput(e)}),n.querySelector("button.remove")?.addEventListener("click",e=>{this.removeArrayInput(e)})}removeArrayInput(t){t.preventDefault(),(t.currentTarget?.parentNode).remove()}handleFormSubmit(t,o=function(s){},n=function(s){},e=[]){if(document.querySelector(t))var s=document.querySelector(t);else return!1;s.addEventListener("submit",function(c){c.preventDefault(),q.configure({parent:".module-loading-indicator",showSpinner:!0}),q.start();var u=new FormData(s);for(let[m,b]of Array.from(u.entries()))b===""&&u.delete(m);var l=s.querySelector('*[type="submit"]'),d=l.querySelector("span.spinner"),p=new XMLHttpRequest;if(o(u)===!1)return!1;l.disabled=!0,d.classList.toggle("hide"),p.open("POST",s.getAttribute("action")),p.send(u),p.onload=function(){if(q.done(),p.status==200){var m=JSON.parse(p.response);if(e.successCallback&&typeof e.successCallback=="function"){e.successCallback(m);return}l.disabled=!1,d.classList.toggle("hide"),n(m)}else a.error("Ooops","An error occurred",5),l.disabled=!1,d.classList.toggle("hide")},p.onerror=function(){q.done(),a.error("Ooops","An error occurred",5),l.disabled=!1,d.classList.toggle("hide")}})}handleListActionClick(t,o=function(n){}){t.addEventListener("click",n=>{n.preventDefault();const e=new XMLHttpRequest;e.open("GET",t.dataset.url),e.send(),e.onload=()=>{if(e.status==200){const s=JSON.parse(e.response);o(s),a.success("Success",s.message,5)}else a.error("Ooops","An error occurred",5)},e.onerror=()=>{a.error("Ooops","An error occurred",5)}})}deleteRequest(t,o,n=function(e){}){var e=new XMLHttpRequest,s=new FormData(o);e.open("POST",t),e.send(s),e.onload=function(){if(e.status==200){var c=JSON.parse(e.response);n(c),a.success("Success",c.message,5)}else a.error("Ooops","An error occurred",5)},e.onerror=function(){a.error("Ooops","An error occurred",5)}}updateFormValues(t,o){let n=document.querySelector(t),e=n.querySelector('*[type="submit"] span.value'),s=n.querySelector('button[class*="-delete"]');Object.entries(o).forEach(([c,u])=>{let l='[name="request#'+c+'"]';if(n.querySelector(l)){let d=n.querySelector(l);c==="parameters"?d.value=JSON.stringify(u):d.value=u}else return}),e.innerHTML="Update",s.removeAttribute("disabled")}}export default new h;
